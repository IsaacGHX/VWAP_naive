# VWAP_naive

---

# 📈 VWAP 交易策略执行与回测框架

欢迎使用我们的VWAP项目！该框架旨在利用机器学习模型预测未来的价格和交易量，并结合VWAP（成交量加权平均价）策略，在给定的交易信号下，以最优的执行成本完成交易。

本项目整合了数据处理、模型训练（Student's t-VAE + Transformer）和策略回测，为您提供一个端到端的量化交易研究解决方案。

前端使用streamlit，后端使用pandas_ta, torch，请注意安装。

模型的预测逻辑可以适当增加 MAA-TSF，请咨询你的同事。

---

## 🚀 项目流程总览

整个项目流程可以分为以下几个核心步骤：

1.  **数据准备**: 从原始的树状目录结构中提取并整合指定合约（如 `IF9999`）的时间序列数据。
2.  **数据调整**: 对整合后的数据进行复权处理，消除因合约切换等因素造成的跳空缺口。
3.  **特征提取**: 使用 **学生t-VAE** (Variational Autoencoder) 模型学习数据中的深度特征。
4.  **序列预测**: 训练一个 **Transformer** 模型，以自回归的方式预测未来的价格和交易量。
5.  **策略回测**: 将预测结果融入VWAP执行算法，并使用 `vwap_front.py` 进行详细的回测分析。

---

## 📂 第一步：数据准备与整合

在开始之前，请先准备好您的原始数据。

> **数据源**: 我们使用的数据集可以通过以下链接下载（失效请联系你的同事）：
> [https://pan.baidu.com/s/1tj9Cew7xp7naQO80SKGU-g?pwd=v9wj](https://pan.baidu.com/s/1tj9Cew7xp7naQO80SKGU-g?pwd=v9wj)
>
> **请注意**: 下载并解压后，软件会自动生成一个 `output` 文件夹，其中包含了按日和分钟级别组织的树状结构数据。

您的数据文件夹结构应如下所示：

* **天级数据 (Daily Data)**:
    ```
    YYYYMM/
    └── YYYYMMDD/
        └── YYYYMMDD.csv
    ```
* **分钟级数据 (Minute Data)**:
    ```
    YYYYMM/
    └── YYYYMMDD/
        └── SYMBOL.csv
    ```

---

## 🛠️ 第二步：运行数据处理脚本

根据您需要分析的数据粒度，选择运行对应的脚本，将分散的数据整合成单个CSV文件。

* **选项1: 获取天级数据**
    * 运行脚本: `daily_data_process.py`

* **选项2: 获取分钟级数据**
    * 运行脚本: `min_data_process.py`

* **选项n: 获取更多不同频度数据**
    * 请自行编译脚本 hhh

**在运行前，请务必修改以下关键参数：**

* `ROOT_DATA_DIR`: 将此路径设置为您解压后自动生成的 `output` 文件夹。
* `TARGET_SYMBOL`: 您希望处理的目标合约代码，例如 `'IF9999'`。
* `OUTPUT_DIR`: 指定整合后的CSV文件的输出路径。

---

## 📊 第三步：复权与跳空处理

为了保证数据在合约切换时的连续性，我们需要对价格跳空进行修复。

* **运行脚本**: `adjust_data.py`

此脚本会自动检测并根据设定的阈值调整价格。您可以根据需求调整以下超参数：

* `PRICE_GAP_THRESHOLD`: 定义价格跳空的检测阈值。
* `POSITION_CHANGE_THRESHOLD`: 定义持仓量变化的检测阈值，辅助判断是否为真实跳空。

---

## 🧠 第四步：训练学生t-VAE模型

我们使用变分自编码器（VAE）从数据中学习鲁棒的特征表示。

* **运行脚本**: `VAE_trainer.py`

**核心参数设置**:

* `batch_size`:
    * 对于 **分钟级数据**，建议设置为该品种的 **日内分钟数量** (例如，IF合约为240)。
* `FEATURE_DIM`:
    * 选择用于训练的特征维度。请注意，这里通常不包括 `position` 列，因为它可能存在数据缺失。

成功训练后，您将得到一个名为 `best_tdist_vae_model.pth` 的最优模型文件。

---

## 🤖 第五步：训练Transformer预测模型

接下来，我们训练一个自回归范式的Transformer模型，用于预测未来的价格和交易量。

* **运行脚本**: `dataloader_setup.py`

**训练建议**:

* **Epoch**: 建议只训练 `1` 个epoch。
* **Batch Size**: 建议设置为 `1`。

**结果可视化**:

* 您可以使用 `vis.py` 来生成预测的价格和交易量图表。
* **注意**: 在绘图时，请仔细检查数据是否对齐，并正确设置 `col index` 以选择正确的列进行可视化。

---

## 📈 第六步：VWAP策略回测与执行

最后一步是利用我们训练好的模型进行策略回测，评估VWAP执行的效果。

* **运行脚本**: `vwap_front.py` / `vwap_front_better.py`

**功能**:

* 这两个脚本会根据外部交易信号（详见 [btModel](https://github.com/SEObacktest/btModel) 框架），在信号指定的交易周期内（例如一天内），通过VWAP算法智能地拆分订单，以尽量减少市场冲击和交易成本。
* 脚本将生成详细的回测报告，展示与基准策略（如简单市价单）相比的性能提升。
